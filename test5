-- =====================================================
-- FREEZE TRADE GUI - FULLY FIXED
-- âœ… Toggle circles now visible
-- âœ… Mobile & PC dragging support
-- âœ… Bottom text fully visible
-- âœ… Private server detection
-- âœ… Info button with notification
-- =====================================================

local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")  -- âœ… ADD NOTIFICATION SERVICE

local player = Players.LocalPlayer

-- NOTIFICATION FUNCTION (DEFINED EARLY)
local function showNotification(title, message)
	StarterGui:SetCore("SendNotification", {
		Title = title;
		Text = message;
		Duration = 4;
	})
end

-- SCREEN GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "FreezeTradeGUI"
ScreenGui.IgnoreGuiInset = false  -- âœ… FIXED - Now respects screen boundaries
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = game.CoreGui or player:WaitForChild("PlayerGui")

-- MAIN FRAME
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 250, 0, 240)
MainFrame.Position = UDim2.new(0.5, -125, 0.7, -120)  -- âœ… MOVED DOWN (0.7)
MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)  -- âœ… ANCHOR FROM CENTER
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
MainFrame.BorderSizePixel = 0
MainFrame.ZIndex = 1
MainFrame.Parent = ScreenGui

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 10)
MainCorner.Parent = MainFrame

local MainStroke = Instance.new("UIStroke")
MainStroke.Thickness = 2
MainStroke.Color = Color3.fromRGB(60, 60, 70)
MainStroke.Parent = MainFrame

-- TITLE BAR
local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 36)
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
TitleBar.BorderSizePixel = 0
TitleBar.Active = true
TitleBar.ZIndex = 2
TitleBar.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 10)
TitleCorner.Parent = TitleBar

local TitleStroke = Instance.new("UIStroke")
TitleStroke.Thickness = 1
TitleStroke.Color = Color3.fromRGB(70, 70, 80)
TitleStroke.Parent = TitleBar

local Title = Instance.new("TextLabel")
Title.Text = "FREEZE TRADE"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 15
Title.TextColor3 = Color3.fromRGB(220, 220, 230)
Title.BackgroundTransparency = 1
Title.Size = UDim2.new(1, -80, 1, 0)  -- âœ… ADJUSTED FOR TWO BUTTONS
Title.Position = UDim2.new(0, 12, 0, 0)
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.ZIndex = 3
Title.Parent = TitleBar

-- INFO BUTTON (!)
local InfoButton = Instance.new("TextButton")
InfoButton.Size = UDim2.new(0, 26, 0, 26)
InfoButton.Position = UDim2.new(1, -60, 0.5, -13)  -- âœ… LEFT OF X BUTTON
InfoButton.Text = "!"
InfoButton.Font = Enum.Font.GothamBold
InfoButton.TextSize = 16
InfoButton.TextColor3 = Color3.fromRGB(220, 220, 230)
InfoButton.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
InfoButton.BorderSizePixel = 0
InfoButton.ZIndex = 3
InfoButton.Parent = TitleBar

local InfoCorner = Instance.new("UICorner")
InfoCorner.CornerRadius = UDim.new(0, 6)
InfoCorner.Parent = InfoButton

InfoButton.MouseButton1Click:Connect(function()
	showNotification("REMEMBER", "Private servers are not supported!")
end)

-- CLOSE BUTTON
local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0, 26, 0, 26)
CloseButton.Position = UDim2.new(1, -30, 0.5, -13)
CloseButton.Text = "Ã—"
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 18
CloseButton.TextColor3 = Color3.fromRGB(220, 220, 230)
CloseButton.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
CloseButton.BorderSizePixel = 0
CloseButton.ZIndex = 3
CloseButton.Parent = TitleBar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 6)
CloseCorner.Parent = CloseButton

CloseButton.MouseButton1Click:Connect(function()
	MainFrame.Visible = false  -- âœ… JUST HIDE, DON'T DESTROY
	guiVisible = false
	CircleToggle.BackgroundColor3 = Color3.fromRGB(80, 80, 90)  -- Visual feedback
end)

-- CONTENT
local Content = Instance.new("Frame")
Content.BackgroundTransparency = 1
Content.Size = UDim2.new(1, -24, 1, -145)  -- Adjusted for username section
Content.Position = UDim2.new(0, 12, 0, 117)  -- Moved down to make room
Content.ZIndex = 2
Content.Parent = MainFrame

-- USERNAME INPUT SECTION
local UsernameSection = Instance.new("Frame")
UsernameSection.Size = UDim2.new(1, -24, 0, 65)
UsernameSection.Position = UDim2.new(0, 12, 0, 42)
UsernameSection.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
UsernameSection.BorderSizePixel = 0
UsernameSection.ZIndex = 2
UsernameSection.Parent = MainFrame

local UsernameCorner = Instance.new("UICorner")
UsernameCorner.CornerRadius = UDim.new(0, 8)
UsernameCorner.Parent = UsernameSection

local UsernameLabel = Instance.new("TextLabel")
UsernameLabel.Text = "Victims Username:"
UsernameLabel.Font = Enum.Font.Gotham
UsernameLabel.TextSize = 12
UsernameLabel.TextColor3 = Color3.fromRGB(200, 200, 210)
UsernameLabel.BackgroundTransparency = 1
UsernameLabel.Size = UDim2.new(1, -12, 0, 18)
UsernameLabel.Position = UDim2.new(0, 6, 0, 4)
UsernameLabel.TextXAlignment = Enum.TextXAlignment.Left
UsernameLabel.ZIndex = 3
UsernameLabel.Parent = UsernameSection

-- Username TextBox
local UsernameBox = Instance.new("TextBox")
UsernameBox.Size = UDim2.new(1, -80, 0, 30)
UsernameBox.Position = UDim2.new(0, 6, 0, 28)
UsernameBox.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
UsernameBox.BorderSizePixel = 0
UsernameBox.Text = ""
UsernameBox.PlaceholderText = "Enter username..."
UsernameBox.Font = Enum.Font.Gotham
UsernameBox.TextSize = 13
UsernameBox.TextColor3 = Color3.fromRGB(220, 220, 230)
UsernameBox.PlaceholderColor3 = Color3.fromRGB(120, 120, 130)
UsernameBox.TextXAlignment = Enum.TextXAlignment.Left
UsernameBox.ClearTextOnFocus = false
UsernameBox.ZIndex = 3
UsernameBox.Parent = UsernameSection

local BoxCorner = Instance.new("UICorner")
BoxCorner.CornerRadius = UDim.new(0, 6)
BoxCorner.Parent = UsernameBox

local BoxPadding = Instance.new("UIPadding")
BoxPadding.PaddingLeft = UDim.new(0, 8)
BoxPadding.PaddingRight = UDim.new(0, 8)
BoxPadding.Parent = UsernameBox

-- Profile Picture Display
local ProfilePic = Instance.new("ImageLabel")
ProfilePic.Size = UDim2.new(0, 50, 0, 50)
ProfilePic.Position = UDim2.new(1, -56, 0, 8)
ProfilePic.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
ProfilePic.BorderSizePixel = 0
ProfilePic.Image = ""
ProfilePic.ZIndex = 3
ProfilePic.Parent = UsernameSection

local PicCorner = Instance.new("UICorner")
PicCorner.CornerRadius = UDim.new(1, 0)
PicCorner.Parent = ProfilePic

-- Status indicator inside profile pic
local StatusIndicator = Instance.new("TextLabel")
StatusIndicator.Size = UDim2.new(1, 0, 1, 0)
StatusIndicator.BackgroundTransparency = 1
StatusIndicator.Text = "?"
StatusIndicator.Font = Enum.Font.GothamBold
StatusIndicator.TextSize = 20
StatusIndicator.TextColor3 = Color3.fromRGB(150, 150, 160)
StatusIndicator.ZIndex = 4
StatusIndicator.Parent = ProfilePic

-- TOGGLES
local freezeEnabled = false
local acceptEnabled = false
local guiVisible = true
local targetPlayer = nil
local targetUsername = ""
local isPrivateServer = false  -- âœ… TRACK IF PRIVATE SERVER

local function createToggle(text, y)
	local frame = Instance.new("Frame")
	frame.Size = UDim2.new(1, 0, 0, 40)
	frame.Position = UDim2.new(0, 0, 0, y)
	frame.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
	frame.BorderSizePixel = 0
	frame.ZIndex = 3
	frame.Parent = Content

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 8)
	corner.Parent = frame

	local label = Instance.new("TextLabel")
	label.Text = text
	label.Font = Enum.Font.Gotham
	label.TextSize = 13
	label.TextColor3 = Color3.fromRGB(220, 220, 230)
	label.BackgroundTransparency = 1
	label.Size = UDim2.new(1, -90, 1, 0)
	label.Position = UDim2.new(0, 12, 0, 0)
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.ZIndex = 4
	label.Parent = frame

	-- Toggle button background
	local button = Instance.new("TextButton")
	button.Size = UDim2.new(0, 50, 0, 24)
	button.Position = UDim2.new(1, -58, 0.5, -12)
	button.BackgroundColor3 = Color3.fromRGB(70, 70, 80)
	button.BorderSizePixel = 0
	button.Text = ""
	button.ZIndex = 4
	button.Parent = frame

	local bc = Instance.new("UICorner")
	bc.CornerRadius = UDim.new(1, 0)
	bc.Parent = button

	-- Toggle circle (NOW WITH PROPER ZINDEX + SHADOW)
	local circle = Instance.new("Frame")
	circle.Size = UDim2.new(0, 20, 0, 20)  -- Made slightly bigger
	circle.Position = UDim2.new(0, 2, 0.5, -10)
	circle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)  -- Pure white for visibility
	circle.BorderSizePixel = 0
	circle.ZIndex = 6  -- âœ… EVEN HIGHER ZINDEX
	circle.Parent = button

	local cc = Instance.new("UICorner")
	cc.CornerRadius = UDim.new(1, 0)
	cc.Parent = circle
	
	-- Add shadow/stroke to circle for visibility
	local circleShadow = Instance.new("UIStroke")
	circleShadow.Thickness = 1
	circleShadow.Color = Color3.fromRGB(100, 100, 110)
	circleShadow.Transparency = 0.5
	circleShadow.Parent = circle

	return button, circle
end

local FreezeBtn, FreezeCircle = createToggle("Freeze victims screen", 0)
local AcceptBtn, AcceptCircle = createToggle("Auto accept trade", 46)

local function toggle(btn, circle, state)
	if state then
		TweenService:Create(circle, TweenInfo.new(0.2), {
			Position = UDim2.new(1, -22, 0.5, -10)  -- Adjusted for bigger circle
		}):Play()
		btn.BackgroundColor3 = Color3.fromRGB(80, 200, 80)
	else
		TweenService:Create(circle, TweenInfo.new(0.2), {
			Position = UDim2.new(0, 2, 0.5, -10)  -- Adjusted for bigger circle
		}):Play()
		btn.BackgroundColor3 = Color3.fromRGB(70, 70, 80)
	end
end

-- CHECK IF ALONE IN SERVER (1 player only)
local function checkAloneInServer()
	local playerCount = #Players:GetPlayers()
	
	if playerCount <= 1 then
		isPrivateServer = true  -- Treat solo server as private
	else
		isPrivateServer = false
	end
	
	return isPrivateServer
end

-- âœ… SHOW NOTIFICATION ON LOAD IF ALONE IN SERVER
if checkAloneInServer() then
	task.wait(1) -- Wait a second for GUI to load
	showNotification("PRIVATE SERVER NOT SUPPORTED", "Please rejoin and use it in a public server!")
	
	-- âœ… DISABLE AND GREY OUT BUTTONS WHEN ALONE
	FreezeBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)  -- Dark grey
	AcceptBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)  -- Dark grey
	FreezeBtn.Active = false  -- Make unclickable
	AcceptBtn.Active = false  -- Make unclickable
	
	-- Add visual indication
	local function addDisabledLabel(parent)
		local disabledLabel = Instance.new("TextLabel")
		disabledLabel.Size = UDim2.new(1, 0, 1, 0)
		disabledLabel.BackgroundTransparency = 1
		disabledLabel.Text = "ðŸš«"
		disabledLabel.Font = Enum.Font.GothamBold
		disabledLabel.TextSize = 16
		disabledLabel.TextColor3 = Color3.fromRGB(180, 180, 190)
		disabledLabel.ZIndex = 7
		disabledLabel.Parent = parent
	end
	
	addDisabledLabel(FreezeBtn)
	addDisabledLabel(AcceptBtn)
else
	-- âœ… ONLY INITIALIZE AS DISABLED IF NOT ALONE
	FreezeBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
	AcceptBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
end

FreezeBtn.MouseButton1Click:Connect(function()
	-- âœ… CHECK IF ALONE IN SERVER (1 player)
	if checkAloneInServer() then
		showNotification("PRIVATE SERVER NOT SUPPORTED", "Rejoin and use it in public servers.")
		return
	end
	
	if targetUsername == "" or not targetPlayer then
		-- âœ… SHOW NOTIFICATION WHEN NO PLAYER
		showNotification("USERNAME NOT DETECTED", "Don't forget to put the players name first before freezing the trade!")
		return
	end
	freezeEnabled = not freezeEnabled
	toggle(FreezeBtn, FreezeCircle, freezeEnabled)
end)

AcceptBtn.MouseButton1Click:Connect(function()
	-- âœ… CHECK IF ALONE IN SERVER (1 player)
	if checkAloneInServer() then
		showNotification("PRIVATE SERVER NOT SUPPORTED", "Rejoin and use it in public servers.")
		return
	end
	
	if targetUsername == "" or not targetPlayer then
		-- âœ… SHOW NOTIFICATION WHEN NO PLAYER
		showNotification("USERNAME NOT DETECTED", "Don't forget to put the players name first before freezing the trade!")
		return
	end
	acceptEnabled = not acceptEnabled
	toggle(AcceptBtn, AcceptCircle, acceptEnabled)
end)

-- USERNAME DETECTION LOGIC
local function updatePlayerInfo(username)
	if username == "" then
		-- Reset when empty
		ProfilePic.Image = ""
		StatusIndicator.Text = "?"
		StatusIndicator.TextColor3 = Color3.fromRGB(150, 150, 160)
		StatusIndicator.Visible = true
		targetPlayer = nil
		targetUsername = ""
		
		-- Disable toggles if active
		if freezeEnabled then
			freezeEnabled = false
			toggle(FreezeBtn, FreezeCircle, false)
		end
		if acceptEnabled then
			acceptEnabled = false
			toggle(AcceptBtn, AcceptCircle, false)
		end
		
		-- Make buttons look disabled
		FreezeBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
		AcceptBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
		return
	end
	
	-- Try to find player
	local foundPlayer = nil
	for _, plr in pairs(Players:GetPlayers()) do
		if plr.Name:lower() == username:lower() or plr.DisplayName:lower() == username:lower() then
			foundPlayer = plr
			break
		end
	end
	
	if foundPlayer then
		-- Player found! Just show profile picture
		targetPlayer = foundPlayer
		targetUsername = foundPlayer.Name
		
		-- Update profile picture
		local userId = foundPlayer.UserId
		ProfilePic.Image = "https://www.roblox.com/headshot-thumbnail/image?userId="..userId.."&width=150&height=150&format=png"
		StatusIndicator.Visible = false  -- âœ… HIDE STATUS, JUST SHOW PICTURE
		
		-- Enable buttons visually
		FreezeBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 80)
		AcceptBtn.BackgroundColor3 = Color3.fromRGB(70, 70, 80)
	else
		-- Player not found - just show ?
		targetPlayer = nil
		targetUsername = ""
		ProfilePic.Image = ""
		StatusIndicator.Text = "?"
		StatusIndicator.TextColor3 = Color3.fromRGB(150, 150, 160)  -- âœ… NO RED X
		StatusIndicator.Visible = true
		
		-- Disable toggles
		if freezeEnabled then
			freezeEnabled = false
			toggle(FreezeBtn, FreezeCircle, false)
		end
		if acceptEnabled then
			acceptEnabled = false
			toggle(AcceptBtn, AcceptCircle, false)
		end
		
		-- Make buttons look disabled
		FreezeBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
		AcceptBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
	end
end

-- Update when text changes
UsernameBox:GetPropertyChangedSignal("Text"):Connect(function()
	updatePlayerInfo(UsernameBox.Text)
end)

-- BOTTOM WARNING TEXT
local WarningText = Instance.new("TextLabel")
WarningText.Size = UDim2.new(1, -16, 0, 20)
WarningText.Position = UDim2.new(0, 8, 1, -26)  -- Adjusted for new height
WarningText.BackgroundTransparency = 1
WarningText.Text = "MAKE SURE THAT YOU ARE TRADING BEFORE TURNING IT ON"
WarningText.Font = Enum.Font.Gotham
WarningText.TextSize = 10
WarningText.TextColor3 = Color3.fromRGB(170, 170, 180)
WarningText.TextWrapped = true
WarningText.ZIndex = 3
WarningText.Parent = MainFrame

-- =====================================================
-- IMPROVED DRAG SYSTEM (MOBILE & PC SUPPORT)
-- =====================================================

-- Drag Main GUI
local dragging = false
local dragInput = nil
local dragStart = nil
local startPos = nil

local function updateDrag(input)
	local delta = input.Position - dragStart
	MainFrame.Position = UDim2.new(
		startPos.X.Scale,
		startPos.X.Offset + delta.X,
		startPos.Y.Scale,
		startPos.Y.Offset + delta.Y
	)
end

TitleBar.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or 
	   input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = MainFrame.Position
		
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

TitleBar.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or 
	   input.UserInputType == Enum.UserInputType.Touch then
		dragInput = input
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input == dragInput then
		updateDrag(input)
	end
end)

-- =====================================================
-- FLOATING TOGGLE CIRCLE (DRAGGABLE & CLICKABLE)
-- =====================================================

local CircleToggle = Instance.new("TextButton")
CircleToggle.Size = UDim2.new(0, 50, 0, 50)
CircleToggle.Position = UDim2.new(0, 20, 0.5, -25)
CircleToggle.AnchorPoint = Vector2.new(0, 0)
CircleToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
CircleToggle.BorderSizePixel = 0
CircleToggle.Text = ""  -- âœ… NO ICON, PLAIN CIRCLE
CircleToggle.ZIndex = 100
CircleToggle.Parent = ScreenGui

local CircleCorner = Instance.new("UICorner")
CircleCorner.CornerRadius = UDim.new(1, 0)
CircleCorner.Parent = CircleToggle

-- âœ… NO STROKE - PLAIN

-- Toggle GUI visibility on click
CircleToggle.MouseButton1Click:Connect(function()
	guiVisible = not guiVisible
	MainFrame.Visible = guiVisible
	
	-- Visual feedback
	if guiVisible then
		CircleToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
	else
		CircleToggle.BackgroundColor3 = Color3.fromRGB(80, 80, 90)
	end
end)

-- Drag circle (Mobile & PC support)
local circleDragging = false
local circleInput = nil
local circleStart = nil
local circlePos = nil

CircleToggle.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or 
	   input.UserInputType == Enum.UserInputType.Touch then
		circleDragging = true
		circleStart = input.Position
		circlePos = CircleToggle.Position
		
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				circleDragging = false
			end
		end)
	end
end)

CircleToggle.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or 
	   input.UserInputType == Enum.UserInputType.Touch then
		circleInput = input
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if circleDragging and input == circleInput then
		local delta = input.Position - circleStart
		CircleToggle.Position = UDim2.new(
			circlePos.X.Scale,
			circlePos.X.Offset + delta.X,
			circlePos.Y.Scale,
			circlePos.Y.Offset + delta.Y
		)
	end
end)
